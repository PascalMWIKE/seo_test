import os
from datetime import datetime

REPORT_DIR = "reports"
TEMPLATE_PATH = "templates/report_template.html"
OUTPUT_PATH = "index.html"

# Alle PDFs im reports/-Verzeichnis sammeln
pdf_files = [f for f in os.listdir(REPORT_DIR) if f.endswith(".pdf")]

# Neuester Report nach √Ñnderungsdatum
latest_pdf = max(pdf_files, key=lambda f: os.path.getmtime(os.path.join(REPORT_DIR, f)))

# HTML-Downloadliste
download_links = "\n".join(
    f'<li><a href="{REPORT_DIR}/{f}" download>{f}</a></li>' for f in sorted(pdf_files, reverse=True)
)

# Dino-Spiel HTML + Script
footer_game = '''
<div style="text-align: center; margin-top: 50px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;">
  <h3 style="font-weight: 300;">Schnapp dir alle PP!</h3>
  <canvas id="dinoCanvas" width="600" height="150" style="border-radius: 20px; box-shadow: inset 8px 8px 16px #d1d9e6, inset -8px -8px 16px #ffffff;"></canvas>
  <div style="margin-top: 10px;">Punkte: <span id="score">0</span></div>
  <div id="gameOver" style="color:red; font-weight:bold; display:none; cursor:pointer;">Game Over! Klick zum Neustart.</div>
  <div id="highscores" style="margin-top: 20px; font-size: 14px;">
    <h4>üèÜ Highscores</h4>
    <ol id="highscoreList"></ol>
  </div>
  <p style="font-size: 12px; color: #888; font-weight: 300; margin-top: 40px;">created by Pascal Krautmacher 2025</p>
</div>
<script>
const canvas = document.getElementById("dinoCanvas");
const ctx = canvas.getContext("2d");
let score = 0;
let highScores = JSON.parse(localStorage.getItem("highScores") || "[]");

function updateHighscore(score) {
  let name = prompt("Neuer Highscore! Dein Name:");
  if (!name) return;
  highScores.push({ name, score });
  highScores.sort((a, b) => b.score - a.score);
  highScores = highScores.slice(0, 3);
  localStorage.setItem("highScores", JSON.stringify(highScores));
  renderHighscores();
}

function renderHighscores() {
  const list = document.getElementById("highscoreList");
  if (!list) return;
  list.innerHTML = "";
  highScores.forEach(entry => {
    const li = document.createElement("li");
    li.textContent = `${entry.name}: ${entry.score}`;
    list.appendChild(li);
  });
}

renderHighscores();

// Beispiel-Spielmechanik (platzhalterhaft)
let running = true;
function gameLoop() {
  if (!running) return;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillText("üêä", Math.random()*canvas.width, Math.random()*canvas.height);
  score++;
  document.getElementById("score").textContent = score;
  if (score > 50) {
    running = false;
    document.getElementById("gameOver").style.display = "block";
    if (highScores.length < 3 || score > highScores[2].score) {
      updateHighscore(score);
    }
  } else {
    requestAnimationFrame(gameLoop);
  }
}
gameLoop();

document.getElementById("gameOver").onclick = () => {
  score = 0;
  running = true;
  document.getElementById("gameOver").style.display = "none";
  gameLoop();
};
</script>
'''

# HTML-Template einlesen
with open(TEMPLATE_PATH, "r") as f:
    template = f.read()

# Platzhalter ersetzen f√ºr index.html
html = template.replace("reports/seo_report_2025-05-20.pdf", f"{REPORT_DIR}/{latest_pdf}")
html = html.replace("<li><a href=\"reports/seo_report_2025-05-20.pdf\" download>seo_report_2025-05-20.pdf</a></li>\n<li><a href=\"reports/seo_report_2025-05-15.pdf\" download>seo_report_2025-05-15.pdf</a></li>\n<li><a href=\"reports/seo_report_2025-05-14.pdf\" download>seo_report_2025-05-14.pdf</a></li>\n<li><a href=\"reports/seo_report_2025-05-13.pdf\" download>seo_report_2025-05-13.pdf</a></li>", download_links)
html = html.replace("<footer></footer>", footer_game)

# index.html speichern
with open(OUTPUT_PATH, "w") as f:
    f.write(html)

print(f"index.html erfolgreich erstellt. Neuester Bericht: {latest_pdf}")
