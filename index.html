import os
from datetime import datetime

REPORT_DIR = "reports"
TEMPLATE_PATH = "templates/index_template.html"
OUTPUT_PATH = "index.html"

# Alle PDFs im reports/-Verzeichnis sammeln
pdf_files = [f for f in os.listdir(REPORT_DIR) if f.endswith(".pdf")]

# Neuester Report nach Ã„nderungsdatum
latest_pdf = max(pdf_files, key=lambda f: os.path.getmtime(os.path.join(REPORT_DIR, f)))

# HTML-Downloadliste
download_links = "\n".join(
    f'<li><a href="{REPORT_DIR}/{f}" download>{f}</a></li>' for f in sorted(pdf_files, reverse=True)
)

# Dino-Spiel HTML + Script
footer_game = '''
<div style="text-align: center; margin-top: 50px;">
  <h3>Schnapp dir alle PP!</h3>
  <canvas id="dinoCanvas" width="600" height="150" style="border:1px solid #000"></canvas>
  <div>Punkte: <span id="score">0</span></div>
  <div id="gameOver" style="color:red; font-weight:bold; display:none;">Game Over! Klick zum Neustart.</div>
</div>
<script>
const canvas = document.getElementById('dinoCanvas');
const ctx = canvas.getContext('2d');
let dino = { x: 50, y: 100, width: 20, height: 30, vy: 0, gravity: 1, jumping: false };
let letters = [];
let score = 0;
let gameOver = false;

function drawDino() {
  ctx.fillStyle = 'green';
  ctx.fillRect(dino.x, dino.y, dino.width, dino.height); // body
  ctx.fillRect(dino.x - 5, dino.y + 5, 5, 10); // tail
  ctx.fillStyle = 'black';
  ctx.beginPath(); // eye
  ctx.arc(dino.x + dino.width - 5, dino.y + 5, 2, 0, Math.PI * 2);
  ctx.fill();
}

function drawLetters() {
  ctx.fillStyle = 'black';
  letters.forEach(l => {
    ctx.font = '20px monospace';
    ctx.fillText(l.char, l.x, l.y);
  });
}

function update() {
  if (gameOver) return;
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (dino.jumping) {
    dino.vy += dino.gravity;
    dino.y += dino.vy;
    if (dino.y >= 100) {
      dino.y = 100;
      dino.vy = 0;
      dino.jumping = false;
    }
  }

  drawDino();
  drawLetters();

  letters.forEach(l => l.x -= 2);
  letters = letters.filter(l => l.x > 0);

  letters.forEach(l => {
    if (
      l.x < dino.x + dino.width &&
      l.x + 10 > dino.x &&
      l.y > dino.y &&
      l.y < dino.y + dino.height
    ) {
      if (l.char === 'P') {
        score++;
        document.getElementById('score').textContent = score;
      } else {
        gameOver = true;
        document.getElementById('gameOver').style.display = 'block';
      }
    }
  });

  letters = letters.filter(l => !(l.x < dino.x + dino.width && l.x + 10 > dino.x && l.y > dino.y && l.y < dino.y + dino.height && l.char === 'P'));
}

function spawnLetter() {
  const char = Math.random() < 0.5 ? 'P' : String.fromCharCode(65 + Math.floor(Math.random() * 26));
  const y = 70 + Math.floor(Math.random() * 60);
  letters.push({ x: canvas.width, y: y, char });
}

canvas.addEventListener('click', () => {
  if (gameOver) {
    letters = [];
    score = 0;
    dino.y = 100;
    dino.vy = 0;
    dino.jumping = false;
    gameOver = false;
    document.getElementById('score').textContent = score;
    document.getElementById('gameOver').style.display = 'none';
  } else if (!dino.jumping) {
    dino.vy = -12;
    dino.jumping = true;
  }
});

setInterval(update, 30);
setInterval(spawnLetter, 1500);
</script>
'''

# HTML-Template einlesen
with open(TEMPLATE_PATH, "r") as f:
    template = f.read()

# Platzhalter ersetzen
html = template.replace("{{LATEST_PDF}}", f"{REPORT_DIR}/{latest_pdf}")
html = html.replace("{{PDF_LIST}}", download_links)
html = html.replace("{{FOOTER_GAME}}", footer_game)

# Ausgabe speichern
with open(OUTPUT_PATH, "w") as f:
    f.write(html)

print(f"index.html erfolgreich erstellt. Neuester Bericht: {latest_pdf}")
