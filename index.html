import os
from datetime import datetime

REPORT_DIR = "reports"
TEMPLATE_PATH = "templates/report_template.html"
OUTPUT_PATH = "index.html"

# Alle PDFs im reports/-Verzeichnis sammeln
pdf_files = [f for f in os.listdir(REPORT_DIR) if f.endswith(".pdf")]

# Neuester Report nach √Ñnderungsdatum
latest_pdf = max(pdf_files, key=lambda f: os.path.getmtime(os.path.join(REPORT_DIR, f)))

# HTML-Downloadliste
download_links = "\n".join(
    f'<li><a href="{REPORT_DIR}/{f}" download>{f}</a></li>' for f in sorted(pdf_files, reverse=True)
)

# Dino-Spiel HTML + Script
footer_game = '''
<div style="text-align: center; margin-top: 50px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;">
  <h3 style="font-weight: 300;">Schnapp dir alle PP!</h3>
  <canvas id="dinoCanvas" width="600" height="150" style="border-radius: 20px; box-shadow: inset 8px 8px 16px #d1d9e6, inset -8px -8px 16px #ffffff;"></canvas>
  <div style="margin-top: 10px;">Punkte: <span id="score">0</span></div>
  <div id="gameOver" style="color:red; font-weight:bold; display:none; cursor:pointer;">Game Over! Klick zum Neustart.</div>
  <div id="highscores" style="margin-top: 20px; font-size: 14px;">
    <h4>üèÜ Highscores</h4>
    <ol id="highscoreList"></ol>
  </div>
  <p style="font-size: 12px; color: #888; font-weight: 300; margin-top: 40px;">created by Pascal Krautmacher 2025</p>
</div>
<script>
const canvas = document.getElementById("dinoCanvas");
const ctx = canvas.getContext("2d");
const crocodile = { x: 50, y: 100, vy: 0, jumping: false };
const gravity = 0.5;
const jumpStrength = -8;
const letters = [];
let score = 0;
let running = true;
let highScores = JSON.parse(localStorage.getItem("highScores") || "[]");

function updateHighscore(score) {
  let name = prompt("Neuer Highscore! Dein Name:");
  if (!name) return;
  highScores.push({ name, score });
  highScores.sort((a, b) => b.score - a.score);
  highScores = highScores.slice(0, 3);
  localStorage.setItem("highScores", JSON.stringify(highScores));
  renderHighscores();
}

function renderHighscores() {
  const list = document.getElementById("highscoreList");
  list.innerHTML = "";
  highScores.forEach(entry => {
    const li = document.createElement("li");
    li.textContent = `${entry.name}: ${entry.score}`;
    list.appendChild(li);
  });
}

function resetGame() {
  score = 0;
  crocodile.y = 100;
  crocodile.vy = 0;
  letters.length = 0;
  running = true;
  document.getElementById("gameOver").style.display = "none";
  requestAnimationFrame(gameLoop);
}

function spawnLetter() {
  const isPP = Math.random() < 0.3;
  const char = isPP ? "PP" : String.fromCharCode(65 + Math.floor(Math.random() * 26));
  letters.push({ x: canvas.width, y: 50 + Math.random() * 80, text: char, isPP });
}

function drawCrocodile() {
  ctx.font = "20px Arial";
  ctx.fillText("üêä", crocodile.x, crocodile.y);
}

function drawLetters() {
  ctx.font = "16px Arial";
  letters.forEach(letter => {
    ctx.fillText(letter.text, letter.x, letter.y);
  });
}

function checkCollision(letter) {
  return letter.x < crocodile.x + 30 && letter.x > crocodile.x - 20 && Math.abs(letter.y - crocodile.y) < 20;
}

function gameLoop() {
  if (!running) return;
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Physik
  crocodile.vy += gravity;
  crocodile.y += crocodile.vy;
  if (crocodile.y > 120) {
    crocodile.y = 120;
    crocodile.vy = 0;
    crocodile.jumping = false;
  }

  if (Math.random() < 0.02) spawnLetter();

  letters.forEach(letter => letter.x -= 2);

  // Kollision und Entfernen
  for (let i = letters.length - 1; i >= 0; i--) {
    const letter = letters[i];
    if (checkCollision(letter)) {
      if (letter.isPP) {
        score++;
        letters.splice(i, 1);
      } else {
        running = false;
        document.getElementById("gameOver").style.display = "block";
        if (highScores.length < 3 || score > highScores[2].score) {
          updateHighscore(score);
        }
        return;
      }
    }
    if (letter.x < -30) letters.splice(i, 1);
  }

  drawCrocodile();
  drawLetters();

  document.getElementById("score").textContent = score;
  requestAnimationFrame(gameLoop);
}

renderHighscores();
requestAnimationFrame(gameLoop);

document.addEventListener("keydown", e => {
  if (e.code === "Space" && !crocodile.jumping) {
    crocodile.vy = jumpStrength;
    crocodile.jumping = true;
  }
});
canvas.addEventListener("click", () => {
  if (!crocodile.jumping) {
    crocodile.vy = jumpStrength;
    crocodile.jumping = true;
  }
});
document.getElementById("gameOver").onclick = resetGame;
</script>
'''

# HTML-Template einlesen
with open(TEMPLATE_PATH, "r") as f:
    template = f.read()

# Platzhalter ersetzen f√ºr index.html
html = template.replace("reports/seo_report_2025-05-20.pdf", f"{REPORT_DIR}/{latest_pdf}")
html = html.replace("<li><a href=\"reports/seo_report_2025-05-20.pdf\" download>seo_report_2025-05-20.pdf</a></li>\n<li><a href=\"reports/seo_report_2025-05-15.pdf\" download>seo_report_2025-05-15.pdf</a></li>\n<li><a href=\"reports/seo_report_2025-05-14.pdf\" download>seo_report_2025-05-14.pdf</a></li>\n<li><a href=\"reports/seo_report_2025-05-13.pdf\" download>seo_report_2025-05-13.pdf</a></li>", download_links)
html = html.replace("<footer></footer>", footer_game)

# index.html speichern
with open(OUTPUT_PATH, "w") as f:
    f.write(html)

print(f"index.html erfolgreich erstellt. Neuester Bericht: {latest_pdf}")
